<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Home Redesigner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .image-placeholder {
            background-color: #e2e8f0;
            border: 2px dashed #94a3b8;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-slate-800">
    <div class="min-h-screen container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">AI Home Redesigner</h1>
            <p class="text-lg text-slate-600 mt-2">Transform your space with the power of AI.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            <!-- Input Panel -->
            <div class="glass-panel p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-slate-900">Design Controls</h2>
                <div class="space-y-6">
                    <div>
                        <label for="image-upload" class="block text-sm font-medium text-slate-700 mb-2">1. Upload a photo:</label>
                        <div id="image-preview-container" class="aspect-video w-full rounded-xl image-placeholder flex items-center justify-center cursor-pointer hover:bg-slate-300 transition-colors">
                            <div id="upload-prompt" class="text-center text-slate-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                <p class="mt-1 text-sm">Click to upload an image</p>
                            </div>
                            <img id="image-preview" src="" alt="Your uploaded image" class="hidden object-cover w-full h-full rounded-xl"/>
                        </div>
                        <input type="file" id="image-upload" class="hidden" accept="image/png, image/jpeg">
                    </div>
                     <div>
                        <label for="style-choices" class="block text-sm font-medium text-slate-700 mb-2">2. Select a style (optional):</label>
                        <select id="style-choices" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow bg-white">
                            <option value="">-- Choose a Style --</option>
                            <option value="Modern">Modern</option>
                            <option value="Minimalist">Minimalist</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Scandinavian">Scandinavian</option>
                            <option value="Bohemian">Bohemian</option>
                            <option value="Farmhouse">Farmhouse</option>
                            <option value="Coastal">Coastal</option>
                            <option value="Mid-Century Modern">Mid-Century Modern</option>
                        </select>
                    </div>
                    <div>
                        <label for="prompt" class="block text-sm font-medium text-slate-700 mb-2">3. Describe your vision:</label>
                        <textarea id="prompt" rows="4" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" placeholder="e.g., 'Make my living room modern with a minimalist style, add a large window, and use a neutral color palette.'"></textarea>
                    </div>
                    <button id="redesign-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform active:scale-95 disabled:bg-indigo-400 disabled:cursor-not-allowed">
                        Redesign My Home
                    </button>
                </div>
                 <!-- Error Message -->
                <div id="error-message" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <p id="error-text"></p>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="glass-panel p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-slate-900">AI-Generated Redesign</h2>
                <div class="space-y-6">
                    <div id="output-image-container" class="relative aspect-video w-full rounded-xl image-placeholder flex items-center justify-center">
                        <div id="output-placeholder" class="text-center text-slate-500">
                           <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 01-6.23-.693L4.2 15.3m15.6 0-1.278 4.257A2.25 2.25 0 0116.5 21h-9a2.25 2.25 0 01-2.272-2.443L4.2 15.3m15.6 0a2.25 2.25 0 00-2.25-2.25H6.45a2.25 2.25 0 00-2.25 2.25m15.6 0v-2.134a2.25 2.25 0 00-1.76-2.232l-2.073-.518a2.25 2.25 0 00-2.15.289l-.53.401a2.25 2.25 0 01-2.825 0l-.53-.401a2.25 2.25 0 00-2.15-.289l-2.073.518A2.25 2.25 0 004.2 13.166V15.3" /></svg>
                            <p class="mt-1 text-sm">Your new design will appear here</p>
                        </div>
                        <div id="loader" class="hidden flex-col items-center justify-center text-center">
                            <div class="spinner"></div>
                            <p class="mt-4 text-slate-600">Generating your new home... <br> This can take a moment.</p>
                        </div>
                        <img id="output-image" src="" alt="AI generated redesign" class="hidden object-cover w-full h-full rounded-xl"/>
                        <button id="download-button" class="hidden absolute bottom-4 right-4 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all transform active:scale-95">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            Download
                        </button>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-slate-900 mb-2">Design Description</h3>
                        <div id="output-description" class="p-4 bg-slate-100 rounded-lg min-h-[100px] text-slate-700">
                             <p id="description-placeholder" class="text-slate-500">A detailed description of the design will be generated here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const uploadPrompt = document.getElementById('upload-prompt');
        const imagePreview = document.getElementById('image-preview');
        const promptInput = document.getElementById('prompt');
        const redesignButton = document.getElementById('redesign-button');
        const styleChoices = document.getElementById('style-choices');
        
        const outputImageContainer = document.getElementById('output-image-container');
        const outputPlaceholder = document.getElementById('output-placeholder');
        const loader = document.getElementById('loader');
        const outputImage = document.getElementById('output-image');
        const downloadButton = document.getElementById('download-button');

        const outputDescription = document.getElementById('output-description');
        const descriptionPlaceholder = document.getElementById('description-placeholder');

        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        let base64ImageData = null;
        let fileMimeType = null;
        
        const stylePrompts = {
            'Modern': 'Redesign this in a modern style, focusing on clean lines, a simple color palette, and the use of materials like metal, glass, and steel. ',
            'Minimalist': 'Transform this space with a minimalist aesthetic. Emphasize simplicity, neutral tones, and uncluttered surfaces. ',
            'Industrial': 'Give this an industrial-style makeover, highlighting raw elements like exposed brick, distressed wood, and metal fixtures. ',
            'Scandinavian': 'Redesign this with a Scandinavian influence, prioritizing light, airy spaces, natural textures, and functional, simple furniture. ',
            'Bohemian': 'Embrace a bohemian vibe for this redesign. Use a rich mix of patterns, vibrant colors, natural materials, and a relaxed, eclectic feel. ',
            'Farmhouse': 'Create a modern farmhouse look. This should blend rustic charm with clean, contemporary elements for a cozy and sophisticated feel. ',
            'Coastal': 'Redesign this with a coastal or beach house theme. Use a light and breezy color palette, natural materials like wood and rattan, and comfortable furnishings. ',
            'Mid-Century Modern': 'Transform this with a Mid-Century Modern design, characterized by organic shapes, simple functionality, and a seamless flow between indoors and outdoors. '
        };

        // --- Event Listeners ---
        imagePreviewContainer.addEventListener('click', () => imageUpload.click());

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileMimeType = file.type;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    uploadPrompt.classList.add('hidden');
                    base64ImageData = e.target.result.split(',')[1];
                };
                reader.readAsDataURL(file);
            }
        });
        
        styleChoices.addEventListener('change', (event) => {
            const selectedStyle = event.target.value;
            const currentPrompt = promptInput.value;
            let newPrompt = currentPrompt;

            // Remove any existing style prompt prefix from the map
            Object.values(stylePrompts).forEach(promptText => {
                if (newPrompt.startsWith(promptText)) {
                    newPrompt = newPrompt.substring(promptText.length);
                }
            });

            // Prepend the new style prompt if a style is selected
            if (selectedStyle && stylePrompts[selectedStyle]) {
                newPrompt = stylePrompts[selectedStyle] + newPrompt;
            }

            promptInput.value = newPrompt;
            promptInput.focus();
        });

        redesignButton.addEventListener('click', handleRedesign);
        downloadButton.addEventListener('click', downloadImage);

        // --- Core Logic ---
        async function handleRedesign() {
            // 1. Validation
            if (!base64ImageData) {
                showError("Please upload an image first.");
                return;
            }
            if (!promptInput.value.trim()) {
                showError("Please describe the changes you want.");
                return;
            }
            hideError();

            // 2. Set loading state
            setLoading(true);

            try {
                // 3. Generate Image
                const generatedImageBase64 = await generateImage(promptInput.value, base64ImageData, fileMimeType);
                outputImage.src = `data:image/png;base64,${generatedImageBase64}`;
                outputImage.classList.remove('hidden');
                outputPlaceholder.classList.add('hidden');
                downloadButton.classList.remove('hidden');

                // 4. Generate Description
                descriptionPlaceholder.textContent = "Analyzing the new design...";
                const description = await generateDescription(generatedImageBase64);
                outputDescription.innerHTML = `<p>${description.replace(/\n/g, '<br>')}</p>`;
                descriptionPlaceholder.classList.add('hidden');

            } catch (error) {
                console.error("An error occurred:", error);
                showError("Sorry, something went wrong while creating your design. Please try again.");
                // Reset output on error
                outputImage.classList.add('hidden');
                downloadButton.classList.add('hidden');
                outputPlaceholder.classList.remove('hidden');
                descriptionPlaceholder.classList.remove('hidden');
                outputDescription.innerHTML = '';
                outputDescription.appendChild(descriptionPlaceholder);
                descriptionPlaceholder.textContent = "A detailed description of the design will be generated here.";
            } finally {
                // 5. Unset loading state
                setLoading(false);
            }
        }
        
        async function makeApiCallWithRetry(apiUrl, payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`API Error (Attempt ${attempt + 1}): ${response.status} ${response.statusText}`, errorBody);
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        }


        async function generateImage(userPrompt, imageBase64, mimeType) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: `Your task is to act as a professional architectural visualizer. You will be given an image of a building and a description of a new style. Your goal is to apply the new style to the building *without altering its fundamental structure*. This means the exact position, size, and shape of all doors, windows, rooflines, and other core architectural features MUST remain identical to the original image. You are only changing materials, colors, landscaping, and decorative elements based on this prompt: ${userPrompt}. The output must be a photorealistic image that looks like the original house was renovated, not replaced.` },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: imageBase64
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            const result = await makeApiCallWithRetry(apiUrl, payload);
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

            if (!base64Data) {
                throw new Error("Could not find image data in the API response.");
            }
            return base64Data;
        }

        async function generateDescription(imageBase64) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: "Act as an interior designer. Describe this redesigned home in a detailed and appealing way for a homeowner. Focus on the style, materials, key features, and overall ambiance. Do not mention that you are an AI." },
                        {
                            inlineData: {
                                mimeType: "image/png",
                                data: imageBase64
                            }
                        }
                    ]
                }],
            };

            const result = await makeApiCallWithRetry(apiUrl, payload);
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) {
                throw new Error("Could not find text description in the API response.");
            }
            return text;
        }

        function downloadImage() {
            if (!outputImage.src || outputImage.classList.contains('hidden')) return;

            const link = document.createElement('a');
            link.href = outputImage.src;
            link.download = 'ai-redesigned-home.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- UI Helper Functions ---
        function setLoading(isLoading) {
            if (isLoading) {
                redesignButton.disabled = true;
                redesignButton.textContent = 'Generating...';
                loader.classList.remove('hidden');
                outputImage.classList.add('hidden');
                downloadButton.classList.add('hidden');
                outputPlaceholder.classList.add('hidden');
                descriptionPlaceholder.textContent = "Generating description...";
            } else {
                redesignButton.disabled = false;
                redesignButton.textContent = 'Redesign My Home';
                loader.classList.add('hidden');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }


